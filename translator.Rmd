---
title: "Spatial translator"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    horizontal_layout: scroll
    theme: spacelab
    navbar:
      - { title: "reproducible.co.nz", href: "https://reproducible.co.nz", align: right }
    source_code: embed 
    orientation: columns
---
<style>

body {
  padding-top: 70px;
}


.navbar-brand {
font-family: "Candara";
  font-weight: bold;
  font-size: 24px;
}


</style>


```{r}
library(sf)
library(flexdashboard)
library(shiny)
library(tidyverse)
library(curl)
library(lubridate)
library(shinyFiles)
library(DT)
library(zip)
```

Conversion
=============================================


Column {.sidebar data-width=300}
-------------------------------------

Select **From** then **To** then **Download**.

*You can check the resultant output in the pane on the right*.


<br/>

```{r}
# Input From 
# Copy the line below to make a select box 
  selectInput("from", label = HTML("<b>FROM</b>"), 
    choices = c("csv", "gpx", "kml", "shp (zipped)")
    )
```


```{r}
dataset <- eventReactive(input$file_from,{
  
  if(input$from != "shp (zipped)"){
    
  dataset <- st_read(input$file_from$datapath, quiet = TRUE)
  dataset
  
  } else {
    
  # Create temp files
  zipped <- input$file_from$datapath
  unzipped <- tempfile()
  
  # Unzip the contents of the temp and save unzipped content in 'temp2'
  unzip(zipfile = zipped, exdir = unzipped)

  # Define the shapefile path
  shapefile_path <- file.path(unzipped)
  
  dataset <- st_read(shapefile_path, quiet = TRUE)
  dataset
  
  }
    

})
```


<br/>

```{r}
# Input To 

renderUI({
# Copy the line below to make a select box 
  
  old.choices <-  c("csv", "gpx", "kml", "shp (zipped)")
  new.choices <- old.choices[old.choices != input$from]
  
  selectInput("to", label = HTML("<b>TO</b>"), 
    choices = new.choices)
  
  
})
```

<br/>

```{r, echo = FALSE}
# from sequence

renderUI({
  
  if (input$from == "gpx"){
    
    fileInput("file_from", "Choose gpx file",
                    multiple = FALSE)
    
  } else if (input$from  == "csv"){
  
    fileInput("file_from", "Choose csv file",
                    multiple = FALSE)
  
  } else if (input$from  == "shp (zipped)"){
  
    fileInput("file_from", "Choose shp files (zipped)",
                    multiple = FALSE)
  
  } else {
    
    fileInput("file_from", "Choose kml File",
                    multiple = FALSE)
    
  }
  
  
})

```

<br/>


```{r}
renderUI({
  if (input$from == "csv") {
    # latitude
    numericInput("input.crs",
                label = HTML("<b>Input coordinate ref system (epsg)</b><br/>longlat is default (4326)"),
                value = 4326)
    
  }
  
})
```

<br/>


```{r}
renderUI({
  if (input$from == "csv") {
    # latitude
    selectInput("longitude",
                label = HTML("<b>Select longitude column</b>"),
                choices = sort(unique(names(dataset(
                )))))
    
  }
  
})
```

<br/>

```{r}
# latitude

renderUI({
  if (input$from == "csv") {
    # latitude
    selectInput("latitude",
                label = HTML("<b>Select latitude column</b>"),
                choices = sort(unique(names(dataset(
                )))))
  }
  
})
```

<br/>

```{r}
# Output CRS
numericInput(
  "output.crs",
  label = HTML(
    "<b>Output coordinate ref system (epsg)</b><br/>longlat is default (4326)"
  ),
  value = 4326
)

```

<br/>

```{r}
# Create placeholder for the downloadButton
uiOutput("downloadUI")
```

```{r, echo = FALSE}
output$downloadUI <- renderUI( {
  downloadButton("downBtn", "Download data", style = "width:100%;")
})

 output$downBtn <- downloadHandler(
    filename = function() {
      paste0("Name_your_file.",
             if (input$to != "shp (zipped)") {
               input$to
             } else {
               "zip"
             }
      )
    },
    content = function(file) {
      if (input$to == "gpx") {
        st_write(final(), file, driver = "GPX", waypoints = TRUE, dataset_options = "GPX_USE_EXTENSIONS=YES")
        
    } else if (input$to == "shp (zipped)" ) {
      
      unlink(paste0(normalizePath(tempdir()), "/", dir(tempdir())), recursive = TRUE)
      
      temp_dir <-  tempdir()
      
      name.base <- file.path(temp_dir, "Name this file")
      name.glob <- paste0(name.base, ".*")
      name.shp  <- paste0(name.base, ".shp")
      name.zip  <- paste0(name.base, ".zip")
      
      st_write(final(), dsn = name.shp,  driver = "ESRI Shapefile")
      
      #if (length(Sys.glob(name.glob)) > 0) file.remove(Sys.glob(name.glob))
      
      zipr(zipfile = name.zip, files = Sys.glob(name.glob))
      
      #if (length(Sys.glob(name.glob)) > 0) file.remove(Sys.glob(name.glob))
      
      # copy the zip file to the file argument
      file.copy(name.zip, file)
        
      # remove all the files created
      #file.remove(zip_file, shp_files)
      
      
      } else {
        st_write(final(), file)
      }
    }
  )
  

    
```



Column {.tabset}
-------------------------------------
### Input

```{r}
renderPrint({
  
  print(dataset())
  
})
```




### Output

```{r}
final <- reactive({
  
  if(input$to == "csv"){
    
    dataset <- dataset() %>% st_transform(crs = input$output.crs)
      
    coord <- st_coordinates(dataset)
    st_geometry(dataset) <- NULL
      
    df <- cbind(dataset, coord) %>% as.data.frame()
    
    # as coord as X and Y we must rename
    
    df <- df %>% rename (latitude =Y,
                  longitude = X)
    
    df %>% relocate(latitude) %>% relocate(longitude)
    
  } else if (input$from == "csv") {
    
    dataset <- dataset() 
    
    
    spatial <- st_as_sf(dataset,
                        coords = c(input$longitude, input$latitude), 
                        crs = input$input.crs) %>% 
      st_transform(crs = input$output.crs)
    
    spatial 
    
  } else {
    
     dataset <- dataset() %>% st_transform(crs = input$output.crs)
     dataset
    
}
  
    
})
```

```{r}
renderPrint({
  
  final()
  

})
```


Test
=============================================

```{r}
renderPrint({
  
  if (input$to == "shp (zipped)") {
  
   # Create a temporary file path for the shapefile (note: multiple files are created for a shapefile)
      unlink(paste0(normalizePath(tempdir()), "/", dir(tempdir())), recursive = TRUE)
    
      temp_dir <-  tempdir()
      
      name.base <- file.path(temp_dir, "Name this file")
      name.glob <- paste0(name.base, ".*")
      name.shp  <- paste0(name.base, ".shp")
      name.zip  <- paste0(name.base, ".zip")
      
      st_write(final(), dsn = name.shp,  driver = "ESRI Shapefile")
      
      #if (length(Sys.glob(name.glob)) > 0) file.remove(Sys.glob(name.glob))
      
      zipr(zipfile = name.zip, files = Sys.glob(name.glob))
      
      list.files(temp_dir)
       
       
  
  }
  
 
  
  
})
```



Video help
=============================================
